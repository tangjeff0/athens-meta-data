{
  "url":"https://api.github.com/repos/athensresearch/athens/issues/240",
  "repository_url":"https://api.github.com/repos/athensresearch/athens",
  "labels_url":"https://api.github.com/repos/athensresearch/athens/issues/240/labels{/name}",
  "comments_url":"https://api.github.com/repos/athensresearch/athens/issues/240/comments",
  "events_url":"https://api.github.com/repos/athensresearch/athens/issues/240/events",
  "html_url":"https://github.com/athensresearch/athens/issues/240",
  "id":654817696,
  "node_id":"MDU6SXNzdWU2NTQ4MTc2OTY=",
  "number":240,
  "title":"Figure out why loading big pages is so slow",
  "user":{
    "login":"tangjeff0",
    "id":8952138,
    "node_id":"MDQ6VXNlcjg5NTIxMzg=",
    "avatar_url":"https://avatars1.githubusercontent.com/u/8952138?v=4",
    "gravatar_id":"",
    "url":"https://api.github.com/users/tangjeff0",
    "html_url":"https://github.com/tangjeff0",
    "followers_url":"https://api.github.com/users/tangjeff0/followers",
    "following_url":"https://api.github.com/users/tangjeff0/following{/other_user}",
    "gists_url":"https://api.github.com/users/tangjeff0/gists{/gist_id}",
    "starred_url":"https://api.github.com/users/tangjeff0/starred{/owner}{/repo}",
    "subscriptions_url":"https://api.github.com/users/tangjeff0/subscriptions",
    "organizations_url":"https://api.github.com/users/tangjeff0/orgs",
    "repos_url":"https://api.github.com/users/tangjeff0/repos",
    "events_url":"https://api.github.com/users/tangjeff0/events{/privacy}",
    "received_events_url":"https://api.github.com/users/tangjeff0/received_events",
    "type":"User",
    "site_admin":false
  },
  "labels":[
    {
      "id":2211651333,
      "node_id":"MDU6TGFiZWwyMjExNjUxMzMz",
      "url":"https://api.github.com/repos/athensresearch/athens/labels/type:%20%F0%9F%9A%B4%E2%80%8D%E2%99%80%EF%B8%8F%20%20perf",
      "name":"type: üö¥‚Äç‚ôÄÔ∏è  perf",
      "color":"0075ca",
      "default":false,
      "description":""
    }
  ],
  "state":"closed",
  "locked":false,
  "assignee":{
    "login":"HaojiXu",
    "id":29003511,
    "node_id":"MDQ6VXNlcjI5MDAzNTEx",
    "avatar_url":"https://avatars3.githubusercontent.com/u/29003511?v=4",
    "gravatar_id":"",
    "url":"https://api.github.com/users/HaojiXu",
    "html_url":"https://github.com/HaojiXu",
    "followers_url":"https://api.github.com/users/HaojiXu/followers",
    "following_url":"https://api.github.com/users/HaojiXu/following{/other_user}",
    "gists_url":"https://api.github.com/users/HaojiXu/gists{/gist_id}",
    "starred_url":"https://api.github.com/users/HaojiXu/starred{/owner}{/repo}",
    "subscriptions_url":"https://api.github.com/users/HaojiXu/subscriptions",
    "organizations_url":"https://api.github.com/users/HaojiXu/orgs",
    "repos_url":"https://api.github.com/users/HaojiXu/repos",
    "events_url":"https://api.github.com/users/HaojiXu/events{/privacy}",
    "received_events_url":"https://api.github.com/users/HaojiXu/received_events",
    "type":"User",
    "site_admin":false
  },
  "assignees":[
    {
      "login":"HaojiXu",
      "id":29003511,
      "node_id":"MDQ6VXNlcjI5MDAzNTEx",
      "avatar_url":"https://avatars3.githubusercontent.com/u/29003511?v=4",
      "gravatar_id":"",
      "url":"https://api.github.com/users/HaojiXu",
      "html_url":"https://github.com/HaojiXu",
      "followers_url":"https://api.github.com/users/HaojiXu/followers",
      "following_url":"https://api.github.com/users/HaojiXu/following{/other_user}",
      "gists_url":"https://api.github.com/users/HaojiXu/gists{/gist_id}",
      "starred_url":"https://api.github.com/users/HaojiXu/starred{/owner}{/repo}",
      "subscriptions_url":"https://api.github.com/users/HaojiXu/subscriptions",
      "organizations_url":"https://api.github.com/users/HaojiXu/orgs",
      "repos_url":"https://api.github.com/users/HaojiXu/repos",
      "events_url":"https://api.github.com/users/HaojiXu/events{/privacy}",
      "received_events_url":"https://api.github.com/users/HaojiXu/received_events",
      "type":"User",
      "site_admin":false
    }
  ],
  "milestone":null,
  "created_at":"2020-07-10 14:22:35 UTC",
  "updated_at":"2020-07-20 01:21:01 UTC",
  "closed_at":"2020-07-17 19:11:13 UTC",
  "author_association":"MEMBER",
  "active_lock_reason":null,
  "body":"My guess is that it is `any-char` in the parser. Please see the file attached.\r\n\r\nI timed three different functions against one another.\r\n\r\n1. `identity` - 0.14-0.295 msecs\r\n1. `parse-and-render` - 12681-14405 msecs\r\n1. `parser/block-parser` 14813-15369 msecs\r\n\r\nI ran each function 5 times. The first four times have no print logs. The last iteration prints the output of the function.\r\n\r\n`cmd-f` \"Elapsed time\".\r\n\r\n[tmp.log](https://github.com/athensresearch/athens/files/4922329/tmp.log)\r\n\r\n\r\n```\r\n\r\n(defn time-me\r\n  [data f]\r\n  (doall\r\n    (for [x data]\r\n      (f x)))\r\n  nil)\r\n\r\n\r\n(map (fn [f]\r\n       (dotimes [i 5]\r\n         (if (= i 4)\r\n           (time (time-me data (comp prn f)))\r\n           (time (time-me data f)))))\r\n  [identity parse-and-render parser/block-parser])\r\n```",
  "performed_via_github_app":null,
  "comments":[
    {
      "url":"https://api.github.com/repos/athensresearch/athens/issues/comments/659187162",
      "html_url":"https://github.com/athensresearch/athens/issues/240#issuecomment-659187162",
      "issue_url":"https://api.github.com/repos/athensresearch/athens/issues/240",
      "id":659187162,
      "node_id":"MDEyOklzc3VlQ29tbWVudDY1OTE4NzE2Mg==",
      "user":{
        "login":"roryokane",
        "id":79168,
        "node_id":"MDQ6VXNlcjc5MTY4",
        "avatar_url":"https://avatars0.githubusercontent.com/u/79168?v=4",
        "gravatar_id":"",
        "url":"https://api.github.com/users/roryokane",
        "html_url":"https://github.com/roryokane",
        "followers_url":"https://api.github.com/users/roryokane/followers",
        "following_url":"https://api.github.com/users/roryokane/following{/other_user}",
        "gists_url":"https://api.github.com/users/roryokane/gists{/gist_id}",
        "starred_url":"https://api.github.com/users/roryokane/starred{/owner}{/repo}",
        "subscriptions_url":"https://api.github.com/users/roryokane/subscriptions",
        "organizations_url":"https://api.github.com/users/roryokane/orgs",
        "repos_url":"https://api.github.com/users/roryokane/repos",
        "events_url":"https://api.github.com/users/roryokane/events{/privacy}",
        "received_events_url":"https://api.github.com/users/roryokane/received_events",
        "type":"User",
        "site_admin":false
      },
      "created_at":"2020-07-16 06:26:19 UTC",
      "updated_at":"2020-07-16 06:32:26 UTC",
      "author_association":"CONTRIBUTOR",
      "body":"It makes sense that `any-char` would be slow, so that‚Äôs probably a good guess.\r\n\r\nThe parse rule introduced [in commit `9433e79`](https://github.com/athensresearch/athens/commit/9433e79d2c30f5e7ab2ccd9feb953132b0e30b96#diff-881af7a0c0560f5d6837f19e442a8132R20) demonstrates a more efficient way to parse ‚Äúany chars‚Äù:\r\n\r\n~~~\r\n<any-non-page-link-chars> = #'[^\\\\[\\\\]]*'\r\n~~~\r\n\r\nWe can probably replace other uses of `any-chars` with similar constructions if that turns out to be necessary for performance.\r\n\r\nI didn‚Äôt write the parser with regexes like that to start with because such regexes slightly increase the difficulty of adding new syntax that may be nested. For example, if page links could contain `**bold**` text (they cannot), the above rule would have to changed, for example to this:\r\n\r\n~~~\r\n<any-non-page-link-chars> = #'([^*\\\\[\\\\]]|\\\\*[^*])*'\r\n~~~\r\n\r\nThere are other ways to write that, e.g. using a shorter regex paired with another parse rule. The point is that where `any-chars` is replaced with regexes, the information that the syntax for bold text is `**` would be duplicated inside those regexes, instead of only being specified in the `bold` rule.",
      "performed_via_github_app":null
    },
    {
      "url":"https://api.github.com/repos/athensresearch/athens/issues/comments/659460200",
      "html_url":"https://github.com/athensresearch/athens/issues/240#issuecomment-659460200",
      "issue_url":"https://api.github.com/repos/athensresearch/athens/issues/240",
      "id":659460200,
      "node_id":"MDEyOklzc3VlQ29tbWVudDY1OTQ2MDIwMA==",
      "user":{
        "login":"nthd3gr33",
        "id":37888959,
        "node_id":"MDQ6VXNlcjM3ODg4OTU5",
        "avatar_url":"https://avatars3.githubusercontent.com/u/37888959?v=4",
        "gravatar_id":"",
        "url":"https://api.github.com/users/nthd3gr33",
        "html_url":"https://github.com/nthd3gr33",
        "followers_url":"https://api.github.com/users/nthd3gr33/followers",
        "following_url":"https://api.github.com/users/nthd3gr33/following{/other_user}",
        "gists_url":"https://api.github.com/users/nthd3gr33/gists{/gist_id}",
        "starred_url":"https://api.github.com/users/nthd3gr33/starred{/owner}{/repo}",
        "subscriptions_url":"https://api.github.com/users/nthd3gr33/subscriptions",
        "organizations_url":"https://api.github.com/users/nthd3gr33/orgs",
        "repos_url":"https://api.github.com/users/nthd3gr33/repos",
        "events_url":"https://api.github.com/users/nthd3gr33/events{/privacy}",
        "received_events_url":"https://api.github.com/users/nthd3gr33/received_events",
        "type":"User",
        "site_admin":false
      },
      "created_at":"2020-07-16 14:45:32 UTC",
      "updated_at":"2020-07-16 14:45:32 UTC",
      "author_association":"MEMBER",
      "body":"Thank you for looking into this issue @roryokane üôè ",
      "performed_via_github_app":null
    },
    {
      "url":"https://api.github.com/repos/athensresearch/athens/issues/comments/659948413",
      "html_url":"https://github.com/athensresearch/athens/issues/240#issuecomment-659948413",
      "issue_url":"https://api.github.com/repos/athensresearch/athens/issues/240",
      "id":659948413,
      "node_id":"MDEyOklzc3VlQ29tbWVudDY1OTk0ODQxMw==",
      "user":{
        "login":"HaojiXu",
        "id":29003511,
        "node_id":"MDQ6VXNlcjI5MDAzNTEx",
        "avatar_url":"https://avatars3.githubusercontent.com/u/29003511?v=4",
        "gravatar_id":"",
        "url":"https://api.github.com/users/HaojiXu",
        "html_url":"https://github.com/HaojiXu",
        "followers_url":"https://api.github.com/users/HaojiXu/followers",
        "following_url":"https://api.github.com/users/HaojiXu/following{/other_user}",
        "gists_url":"https://api.github.com/users/HaojiXu/gists{/gist_id}",
        "starred_url":"https://api.github.com/users/HaojiXu/starred{/owner}{/repo}",
        "subscriptions_url":"https://api.github.com/users/HaojiXu/subscriptions",
        "organizations_url":"https://api.github.com/users/HaojiXu/orgs",
        "repos_url":"https://api.github.com/users/HaojiXu/repos",
        "events_url":"https://api.github.com/users/HaojiXu/events{/privacy}",
        "received_events_url":"https://api.github.com/users/HaojiXu/received_events",
        "type":"User",
        "site_admin":false
      },
      "created_at":"2020-07-17 08:11:04 UTC",
      "updated_at":"2020-07-17 08:11:04 UTC",
      "author_association":"MEMBER",
      "body":"I read the issues section of instaparse, and here's their advice: \r\n* <https://github.com/Engelberg/instaparse/issues/131>\r\n* <https://github.com/Engelberg/instaparse/blob/master/docs/Performance.md>\r\n\r\nBecause people over there mentioned avoid regex combinations & use LL(1)-like rules as much as possible, so I made a experimental parser with their advices here: https://github.com/athensresearch/athens/compare/master...HaojiXu:master\r\n\r\nI'm currently getting 1 second loading times when it comes to large pages, and also documented the parser with comments regarding expanding it.\r\n\r\nOne minor problem though is that Unicode regex matches didn't seem to work anymore - instead of matching letters, marks, and numbers (for characters in these Unicode classes) it only matches the three literal characters (L,M,N). So for now I changed it to a ASCII-only hashtag parser, and I'm interested to know how can I solve it.\r\n\r\nThanks for the great contributions!\r\n",
      "performed_via_github_app":null
    },
    {
      "url":"https://api.github.com/repos/athensresearch/athens/issues/comments/660290794",
      "html_url":"https://github.com/athensresearch/athens/issues/240#issuecomment-660290794",
      "issue_url":"https://api.github.com/repos/athensresearch/athens/issues/240",
      "id":660290794,
      "node_id":"MDEyOklzc3VlQ29tbWVudDY2MDI5MDc5NA==",
      "user":{
        "login":"tangjeff0",
        "id":8952138,
        "node_id":"MDQ6VXNlcjg5NTIxMzg=",
        "avatar_url":"https://avatars1.githubusercontent.com/u/8952138?v=4",
        "gravatar_id":"",
        "url":"https://api.github.com/users/tangjeff0",
        "html_url":"https://github.com/tangjeff0",
        "followers_url":"https://api.github.com/users/tangjeff0/followers",
        "following_url":"https://api.github.com/users/tangjeff0/following{/other_user}",
        "gists_url":"https://api.github.com/users/tangjeff0/gists{/gist_id}",
        "starred_url":"https://api.github.com/users/tangjeff0/starred{/owner}{/repo}",
        "subscriptions_url":"https://api.github.com/users/tangjeff0/subscriptions",
        "organizations_url":"https://api.github.com/users/tangjeff0/orgs",
        "repos_url":"https://api.github.com/users/tangjeff0/repos",
        "events_url":"https://api.github.com/users/tangjeff0/events{/privacy}",
        "received_events_url":"https://api.github.com/users/tangjeff0/received_events",
        "type":"User",
        "site_admin":false
      },
      "created_at":"2020-07-17 19:11:13 UTC",
      "updated_at":"2020-07-17 19:11:13 UTC",
      "author_association":"MEMBER",
      "body":"Closed by #268 ",
      "performed_via_github_app":null
    },
    {
      "url":"https://api.github.com/repos/athensresearch/athens/issues/comments/660744301",
      "html_url":"https://github.com/athensresearch/athens/issues/240#issuecomment-660744301",
      "issue_url":"https://api.github.com/repos/athensresearch/athens/issues/240",
      "id":660744301,
      "node_id":"MDEyOklzc3VlQ29tbWVudDY2MDc0NDMwMQ==",
      "user":{
        "login":"tangjeff0",
        "id":8952138,
        "node_id":"MDQ6VXNlcjg5NTIxMzg=",
        "avatar_url":"https://avatars1.githubusercontent.com/u/8952138?v=4",
        "gravatar_id":"",
        "url":"https://api.github.com/users/tangjeff0",
        "html_url":"https://github.com/tangjeff0",
        "followers_url":"https://api.github.com/users/tangjeff0/followers",
        "following_url":"https://api.github.com/users/tangjeff0/following{/other_user}",
        "gists_url":"https://api.github.com/users/tangjeff0/gists{/gist_id}",
        "starred_url":"https://api.github.com/users/tangjeff0/starred{/owner}{/repo}",
        "subscriptions_url":"https://api.github.com/users/tangjeff0/subscriptions",
        "organizations_url":"https://api.github.com/users/tangjeff0/orgs",
        "repos_url":"https://api.github.com/users/tangjeff0/repos",
        "events_url":"https://api.github.com/users/tangjeff0/events{/privacy}",
        "received_events_url":"https://api.github.com/users/tangjeff0/received_events",
        "type":"User",
        "site_admin":false
      },
      "created_at":"2020-07-20 01:09:08 UTC",
      "updated_at":"2020-07-20 01:21:01 UTC",
      "author_association":"MEMBER",
      "body":"[new-time.log](https://github.com/athensresearch/athens/files/4944992/new-time.log)\r\n\r\n**New times**\r\n\r\n`identity`: 0.17 - 0.92\r\n`parser/block-parser `: 267 - 652 ms\r\n`parse-and-render`: 253 - 538 ms\r\n\r\n**Original times**\r\n\r\n`identity` - 0.14-0.295 msecs\r\n`parse-and-render` - 12681-14405 msecs\r\n`parse/block-parser` 14813-15369 msecs\r\n\r\n**Quick Maths**\r\n\r\n`identity` - control variable\r\n\r\n`parse-and-render`\r\n - lower bounds: 12681/267 = 47.5\r\n - upper bounds: 14405/652 = 22.0\r\n\r\n`parse/block-parser`\r\n- lower bounds: 14813/253 = 58.6\r\n- upper bounds: 15369/652 = 23.6",
      "performed_via_github_app":null
    }
  ]
}
